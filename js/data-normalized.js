/**
 * NORMALIZED Transit Data Structure for Ruse, Bulgaria
 *
 * Key improvements:
 * 1. Each stop has a unique ID (S001, S002, etc.)
 * 2. Lines reference stops by ID, not by name
 * 3. Stop names stored in ONE place only
 * 4. Aliases handle name variations for search
 */

// ============================================================
// STOPS REGISTRY - Single source of truth (104 stops → ~70 unique)
// ============================================================
const STOPS = {
    // ═══════════════════════════════════════════════════════════
    // MAJOR HUBS
    // ═══════════════════════════════════════════════════════════
    'S001': {
        name: 'пл. Оборище',
        lat: 43.8459702,
        lng: 25.9602767,
        type: 'major',
        aliases: ['Площад Оборище', 'Оборище', 'Център']
    },
    'S002': {
        name: 'Централна ЖП гара',
        lat: 43.8339791,
        lng: 25.9558116,
        type: 'major',
        aliases: ['ЖП гара', 'Гарата', 'Централна гара', 'Централна ЖП гара (ул. Николаевска)']
    },
    'S003': {
        name: 'Мол Русе',
        lat: 43.8521146,
        lng: 25.9903358,
        type: 'major',
        aliases: ['Mall Ruse', 'Мол', 'Мол Русе (Трета поликлиника)', 'Трета поликлиника']
    },
    'S004': {
        name: 'Автогара Изток',
        lat: 43.8545,
        lng: 25.9789,
        type: 'major',
        aliases: ['Източна автогара']
    },
    'S005': {
        name: 'Автогара Юг',
        lat: 43.8349282,
        lng: 25.9579841,
        type: 'major',
        aliases: ['Южна автогара']
    },

    // ═══════════════════════════════════════════════════════════
    // RESIDENTIAL - SOUTH (Чародейка)
    // ═══════════════════════════════════════════════════════════
    'S010': {
        name: 'ж.к. Чародейка',
        lat: 43.8400142,
        lng: 25.9723021,
        type: 'terminal',
        aliases: ['Чародейка']
    },
    'S011': {
        name: 'ж.к. Чародейка Юг',
        lat: 43.8319765,
        lng: 25.9774869,
        type: 'terminal',
        aliases: ['Чародейка Юг', 'ж.к. Чародейка Юг (Търговски комплекс)']
    },
    'S012': {
        name: 'Търговски комплекс',
        lat: 43.8320675,
        lng: 25.977283,
        type: 'regular',
        aliases: []
    },
    'S013': {
        name: 'ул. Тодор Икономов',
        lat: 43.8321677,
        lng: 25.9772772,
        type: 'regular',
        aliases: ['Тодор Икономов']
    },
    'S014': {
        name: 'бул. Васил Левски',
        lat: 43.8284917,
        lng: 25.9668596,
        type: 'regular',
        aliases: ['Васил Левски']
    },
    'S015': {
        name: 'Блок 115',
        lat: 43.8245327,
        lng: 25.9752719,
        type: 'regular',
        aliases: []
    },

    // ═══════════════════════════════════════════════════════════
    // RESIDENTIAL - SOUTH (Дружба)
    // ═══════════════════════════════════════════════════════════
    'S020': {
        name: 'ж.к. Дружба 1',
        lat: 43.8311741,
        lng: 25.9655516,
        type: 'regular',
        aliases: ['Дружба 1']
    },
    'S021': {
        name: 'ж.к. Дружба 2',
        lat: 43.8287546,
        lng: 25.9593004,
        type: 'regular',
        aliases: ['Дружба 2']
    },
    'S022': {
        name: 'ж.к. Дружба 3',
        lat: 43.8267258,
        lng: 25.9720696,
        type: 'terminal',
        aliases: ['Дружба 3', 'ж.к. Дружба 3 (Блок 45)']
    },
    'S023': {
        name: 'Блок 18',
        lat: 43.8305847,
        lng: 25.9704323,
        type: 'regular',
        aliases: []
    },
    'S024': {
        name: 'Блок 45',
        lat: 43.8260,
        lng: 25.9730,
        type: 'regular',
        aliases: []
    },
    'S025': {
        name: 'Блок 56',
        lat: 43.8240,
        lng: 25.9625,
        type: 'regular',
        aliases: []
    },
    'S026': {
        name: 'Трети март',
        lat: 43.8290,
        lng: 25.9685,
        type: 'regular',
        aliases: ['3-ти март']
    },
    'S027': {
        name: 'Св. Георги',
        lat: 43.8360956,
        lng: 25.9552387,
        type: 'regular',
        aliases: ['Свети Георги']
    },
    'S028': {
        name: 'Спортна зала',
        lat: 43.829,
        lng: 25.956,
        type: 'regular',
        aliases: ['Спортна зала Дружба']
    },

    // ═══════════════════════════════════════════════════════════
    // CENTRAL - бул. Липник corridor
    // ═══════════════════════════════════════════════════════════
    'S030': {
        name: 'бул. Липник',
        lat: 43.8467,
        lng: 25.9456,
        type: 'regular',
        aliases: ['Липник']
    },
    'S031': {
        name: 'Мосю Бриколаж',
        lat: 43.8460496,
        lng: 25.9616165,
        type: 'regular',
        aliases: ['Mr. Bricolage']
    },
    'S032': {
        name: 'Кауфланд',
        lat: 43.8456,
        lng: 25.9412,
        type: 'regular',
        aliases: ['Kaufland']
    },
    'S033': {
        name: 'Найден Киров',
        lat: 43.849,
        lng: 25.95,
        type: 'regular',
        aliases: []
    },
    'S034': {
        name: 'Олимп',
        lat: 43.851,
        lng: 25.956,
        type: 'regular',
        aliases: ['Стадион Олимп']
    },
    'S035': {
        name: 'Подстанция',
        lat: 43.8525,
        lng: 25.959,
        type: 'regular',
        aliases: []
    },

    // ═══════════════════════════════════════════════════════════
    // CENTRAL - бул. Цар Освободител corridor
    // ═══════════════════════════════════════════════════════════
    'S040': {
        name: 'бул. Цар Освободител',
        lat: 43.8426417,
        lng: 25.9602403,
        type: 'regular',
        aliases: ['Цар Освободител']
    },
    'S041': {
        name: 'Печатни платки',
        lat: 43.8333381,
        lng: 25.9693878,
        type: 'regular',
        aliases: []
    },
    'S042': {
        name: 'бул. Христо Ботев',
        lat: 43.836,
        lng: 25.96,
        type: 'regular',
        aliases: ['Христо Ботев']
    },
    'S043': {
        name: 'Хотел Рига',
        lat: 43.8533271,
        lng: 25.9518848,
        type: 'regular',
        aliases: ['Рига']
    },
    'S044': {
        name: 'Училище Йордан Йовков',
        lat: 43.8407041,
        lng: 25.9604963,
        type: 'regular',
        aliases: ['Й. Йовков', 'Училище Й. Йовков', 'Кооперативен пазар', 'Кооперативен пазар (ЖП прелез)']
    },
    'S045': {
        name: 'Пристанище',
        lat: 43.84016,
        lng: 25.93975,
        type: 'regular',
        aliases: ['Пристанището']
    },

    // ═══════════════════════════════════════════════════════════
    // NORTHEAST - Спортна зала / Болница / Университет corridor
    // ═══════════════════════════════════════════════════════════
    'S050': {
        name: 'Спортна зала ОЗК Арена',
        lat: 43.8463935,
        lng: 25.9620279,
        type: 'regular',
        aliases: ['ОЗК Арена', 'Спортна зала ОЗК']
    },
    'S051': {
        name: 'Пантеона',
        lat: 43.8496903,
        lng: 25.9591298,
        type: 'regular',
        aliases: ['Пантеон']
    },
    'S052': {
        name: 'бул. Съединение',
        lat: 43.8544551,
        lng: 25.9626163,
        type: 'regular',
        aliases: ['Съединение']
    },
    'S053': {
        name: 'ул. Св. Наум',
        lat: 43.8539678,
        lng: 25.9634421,
        type: 'regular',
        aliases: ['Св. Наум']
    },
    'S054': {
        name: 'Парк на Възрожденците',
        lat: 43.8519602,
        lng: 25.9626969,
        type: 'regular',
        aliases: ['Възрожденци']
    },
    'S055': {
        name: 'Окръжна болница',
        lat: 43.8537299,
        lng: 25.9627048,
        type: 'major',
        aliases: ['Болницата', 'УМБАЛ']
    },
    'S056': {
        name: 'ул. Плиска',
        lat: 43.8594112,
        lng: 25.9753331,
        type: 'regular',
        aliases: ['Плиска']
    },
    'S057': {
        name: 'Първа пролет',
        lat: 43.8546432,
        lng: 25.9657783,
        type: 'regular',
        aliases: []
    },
    'S058': {
        name: 'Русенски университет',
        lat: 43.8634,
        lng: 25.9956,
        type: 'major',
        aliases: ['Университет', 'РУ Ангел Кънчев']
    },
    'S059': {
        name: 'кв. Париж',
        lat: 43.858828,
        lng: 25.9744117,
        type: 'regular',
        aliases: ['Париж']
    },
    'S060': {
        name: 'ж.к. Цветница',
        lat: 43.8601176,
        lng: 25.979543,
        type: 'regular',
        aliases: ['Цветница']
    },

    // ═══════════════════════════════════════════════════════════
    // FAR NORTHEAST - Захарен завод corridor
    // ═══════════════════════════════════════════════════════════
    'S065': {
        name: 'бул. Тутракан',
        lat: 43.8671856,
        lng: 25.9889152,
        type: 'regular',
        aliases: ['Тутракан']
    },
    'S066': {
        name: 'ж.к. Тракция',
        lat: 43.8643889,
        lng: 25.9862451,
        type: 'regular',
        aliases: ['Тракция', 'ЛВЗ', 'ж.к. Тракция (ЛВЗ)']
    },
    'S067': {
        name: 'Психодиспансер',
        lat: 43.8650046,
        lng: 25.9882167,
        type: 'regular',
        aliases: []
    },
    'S068': {
        name: 'Захарен завод',
        lat: 43.8756,
        lng: 26.0123,
        type: 'terminal',
        aliases: ['Захарния', 'Захарен завод (Тутракан №25)']
    },
    'S069': {
        name: 'ПГ по транспорт',
        lat: 43.8722581,
        lng: 26.0035767,
        type: 'regular',
        aliases: ['Гимназия по транспорт']
    },
    'S070': {
        name: 'Еконт Експрес',
        lat: 43.8736737,
        lng: 26.0114126,
        type: 'regular',
        aliases: ['Еконт Експрес (Домостроене АД)', 'Домостроене АД']
    },
    'S071': {
        name: 'Митница (Дунав мост)',
        lat: 43.8752996,
        lng: 26.0156611,
        type: 'terminal',
        aliases: ['Дунав мост', 'Митница']
    },
    'S072': {
        name: 'Кероес',
        lat: 43.8700,
        lng: 25.9920,
        type: 'regular',
        aliases: ['Индустриален парк']
    },

    // ═══════════════════════════════════════════════════════════
    // NORTH - Гара Разпределителна area
    // ═══════════════════════════════════════════════════════════
    'S075': {
        name: 'Гара Разпределителна',
        lat: 43.8576557,
        lng: 25.997469,
        type: 'terminal',
        aliases: ['Разпределителна']
    },
    'S076': {
        name: 'ул. Иван Ведър',
        lat: 43.8587855,
        lng: 25.9941759,
        type: 'regular',
        aliases: ['Иван Ведър']
    },
    'S077': {
        name: 'Печатница Дунав',
        lat: 43.8545,
        lng: 25.9790,
        type: 'regular',
        aliases: ['Дунав прес']
    },

    // ═══════════════════════════════════════════════════════════
    // WEST - ЖП гара / Хиподрум corridor
    // ═══════════════════════════════════════════════════════════
    'S080': {
        name: 'ул. Борисова',
        lat: 43.8425548,
        lng: 25.9544909,
        type: 'regular',
        aliases: ['Борисова', 'бул. Борисова']
    },
    'S081': {
        name: 'Лермонтов',
        lat: 43.838226,
        lng: 25.9553586,
        type: 'regular',
        aliases: []
    },
    'S082': {
        name: 'Орхидея',
        lat: 43.8409082,
        lng: 25.9548277,
        type: 'regular',
        aliases: []
    },
    'S083': {
        name: 'Медицински център',
        lat: 43.8440251,
        lng: 25.9543539,
        type: 'regular',
        aliases: ['Поликлиника']
    },
    'S084': {
        name: 'бул. Ген. Скобелев',
        lat: 43.8425721,
        lng: 25.9484956,
        type: 'regular',
        aliases: ['Скобелев']
    },
    'S085': {
        name: 'СБА',
        lat: 43.8452796,
        lng: 25.9569194,
        type: 'regular',
        aliases: ['СБА (Скобелев)', 'Скобелев (СБА)']
    },
    'S086': {
        name: 'Хиподрум',
        lat: 43.82,
        lng: 25.968,
        type: 'regular',
        aliases: []
    },
    'S087': {
        name: 'бул. България',
        lat: 43.823,
        lng: 25.962,
        type: 'regular',
        aliases: ['България']
    },
    'S088': {
        name: 'Левента',
        lat: 43.8245405,
        lng: 25.9576434,
        type: 'regular',
        aliases: []
    },
    'S089': {
        name: 'Верила',
        lat: 43.8341989,
        lng: 25.9621243,
        type: 'regular',
        aliases: []
    },
    'S090': {
        name: 'Алеко Константинов',
        lat: 43.829,
        lng: 25.954,
        type: 'regular',
        aliases: ['Училище Алеко Константинов']
    },
    'S091': {
        name: 'п.в. Охлюва',
        lat: 43.8300,
        lng: 25.9530,
        type: 'regular',
        aliases: ['Охлюва']
    },
    'S092': {
        name: 'ул. Стефан Стамболов',
        lat: 43.8365453,
        lng: 25.9494551,
        type: 'regular',
        aliases: ['Стефан Стамболов']
    },
    'S093': {
        name: 'бул. Мидия Енос',
        lat: 43.8327518,
        lng: 25.9533624,
        type: 'regular',
        aliases: ['Мидия Енос']
    },
    'S094': {
        name: 'ж.к. Мидия Енос',
        lat: 43.833512,
        lng: 25.951944,
        type: 'regular',
        aliases: []
    },

    // ═══════════════════════════════════════════════════════════
    // FAR WEST - кв. Долапите / Мальовица
    // ═══════════════════════════════════════════════════════════
    'S100': {
        name: 'кв. Долапите',
        lat: 43.7970036,
        lng: 25.9312298,
        type: 'terminal',
        aliases: ['Долапите']
    },
    'S101': {
        name: 'ул. Димитър Басарбовски',
        lat: 43.805,
        lng: 25.935,
        type: 'regular',
        aliases: ['Димитър Басарбовски']
    },
    'S102': {
        name: 'Петролна база',
        lat: 43.79,
        lng: 25.92,
        type: 'terminal',
        aliases: []
    },
    'S103': {
        name: 'кв. Средна кула',
        lat: 43.8113164,
        lng: 25.937739,
        type: 'terminal',
        aliases: ['Средна кула']
    },
    'S104': {
        name: 'Мальовица',
        lat: 43.8098,
        lng: 25.9398,
        type: 'terminal',
        aliases: ['кв. Мальовица', 'Мальовица (Помощно училище)', 'Помощно училище']
    },
    'S105': {
        name: 'ул. Мальовица',
        lat: 43.8238804,
        lng: 25.9479688,
        type: 'regular',
        aliases: []
    },
    'S106': {
        name: 'ул. Тинтява',
        lat: 43.812,
        lng: 25.94,
        type: 'regular',
        aliases: ['Тинтява']
    },
    'S107': {
        name: 'бул. Гоце Делчев',
        lat: 43.815,
        lng: 25.942,
        type: 'regular',
        aliases: ['Гоце Делчев']
    },
    'S108': {
        name: 'Помпена станция',
        lat: 43.8180,
        lng: 25.9450,
        type: 'regular',
        aliases: []
    },

    // ═══════════════════════════════════════════════════════════
    // OTHER NEIGHBORHOODS
    // ═══════════════════════════════════════════════════════════
    'S110': {
        name: 'кв. Здравец',
        lat: 43.818,
        lng: 25.958,
        type: 'terminal',
        aliases: ['Здравец']
    },
    'S111': {
        name: 'кв. Образцов чифлик',
        lat: 43.828,
        lng: 25.965,
        type: 'terminal',
        aliases: ['Образцов чифлик']
    },
    'S112': {
        name: 'ж.к. Изток',
        lat: 43.845,
        lng: 25.965,
        type: 'regular',
        aliases: ['Изток']
    },
    'S113': {
        name: 'пл. Прага',
        lat: 43.847,
        lng: 25.968,
        type: 'regular',
        aliases: ['пл. Прага - Юг', 'Прага']
    },
    'S114': {
        name: 'пл. Хан Крум',
        lat: 43.8467353,
        lng: 25.9568053,
        type: 'regular',
        aliases: ['Хан Крум']
    },
    'S115': {
        name: 'Западна промишлена зона',
        lat: 43.8310606,
        lng: 25.9373802,
        type: 'terminal',
        aliases: ['ЗПЗ']
    },
    'S116': {
        name: 'Източна промишлена зона',
        lat: 43.855,
        lng: 25.99,
        type: 'terminal',
        aliases: ['ИПЗ']
    },

    // ═══════════════════════════════════════════════════════════
    // SPECIAL STOPS
    // ═══════════════════════════════════════════════════════════
    'S120': {
        name: 'Метро',
        lat: 43.8423,
        lng: 25.9367,
        type: 'regular',
        aliases: ['Metro']
    },
    'S121': {
        name: 'Дом на културата',
        lat: 43.855869,
        lng: 25.9621797,
        type: 'regular',
        aliases: []
    },
    'S122': {
        name: 'Асфалтова база',
        lat: 43.853,
        lng: 25.985,
        type: 'terminal',
        aliases: ['Асфалтова база - Запад']
    },
    'S123': {
        name: 'Гимназия по корабостроене',
        lat: 43.856,
        lng: 25.96,
        type: 'regular',
        aliases: ['Корабостроене']
    },
};

// ═══════════════════════════════════════════════════════════════
// LINES - Reference stops by ID
// ═══════════════════════════════════════════════════════════════
const LINES = {
    // ─────────────────────────────────────────────────────────────
    // TROLLEYBUS LINES (7)
    // ─────────────────────────────────────────────────────────────
    'T2': {
        number: '2',
        name: 'Линия 2',
        type: 'trolleybus',
        operator: 'gradski',
        route: 'ж.к. Дружба 3 - Център - ж.к. Чародейка',
        color: '#dc2626',
        stops: [
            'S022', // ж.к. Дружба 3
            'S023', // Блок 18
            'S026', // Трети март
            'S027', // Св. Георги
            'S030', // бул. Липник
            'S031', // Мосю Бриколаж
            'S032', // Кауфланд
            'S033', // Найден Киров
            'S034', // Олимп
            'S035', // Подстанция
            'S003', // Мол Русе
            'S001', // пл. Оборище
            'S040', // бул. Цар Освободител
            'S041', // Печатни платки
            'S042', // бул. Христо Ботев
            'S010'  // ж.к. Чародейка
        ],
        schedule: {
            weekday: { first: '05:30', last: '22:00', frequency: '10-15 мин' },
            weekend: { first: '06:00', last: '21:30', frequency: '15-20 мин' }
        }
    },
    'T9': {
        number: '9',
        name: 'Линия 9',
        type: 'trolleybus',
        operator: 'gradski',
        route: 'ж.к. Чародейка - Център - ж.к. Дружба 1',
        color: '#dc2626',
        stops: [
            'S011', // ж.к. Чародейка Юг
            'S012', // Търговски комплекс
            'S013', // ул. Тодор Икономов
            'S014', // бул. Васил Левски
            'S015', // Блок 115
            'S041', // Печатни платки
            'S040', // бул. Цар Освободител
            'S044', // Училище Йордан Йовков
            'S001', // пл. Оборище
            'S030', // бул. Липник
            'S020', // Дружба 1
            'S028'  // Спортна зала
        ],
        schedule: {
            weekday: { first: '05:45', last: '21:30', frequency: '12-18 мин' },
            weekend: { first: '06:15', last: '21:00', frequency: '18-25 мин' }
        }
    },
    'T13': {
        number: '13',
        name: 'Линия 13',
        type: 'trolleybus',
        operator: 'gradski',
        route: 'Гара Разпределителна - Център - ж.к. Дружба 2',
        color: '#dc2626',
        stops: [
            'S075', // Гара Разпределителна
            'S004', // Автогара Изток
            'S076', // ул. Иван Ведър
            'S077', // Печатница Дунав
            'S003', // Мол Русе
            'S035', // Подстанция
            'S034', // Олимп
            'S033', // Найден Киров
            'S032', // Кауфланд
            'S030', // бул. Липник
            'S021', // ж.к. Дружба 2
            'S025'  // Блок 56
        ],
        schedule: {
            weekday: { first: '05:40', last: '21:45', frequency: '12-15 мин' },
            weekend: { first: '06:00', last: '21:00', frequency: '18-22 мин' }
        }
    },
    'T21': {
        number: '21',
        name: 'Линия 21',
        type: 'trolleybus',
        operator: 'gradski',
        route: 'ж.к. Чародейка Юг - Гара Разпределителна',
        color: '#dc2626',
        stops: [
            'S011', // ж.к. Чародейка Юг (Търговски комплекс)
            'S013', // ул. Тодор Икономов
            'S014', // бул. Васил Левски
            'S015', // Блок 115
            'S042', // бул. Христо Ботев
            'S041', // Печатни платки
            'S040', // бул. Цар Освободител
            'S044', // Училище Йордан Йовков
            'S001', // пл. Оборище
            'S030', // бул. Липник
            'S031', // Мосю Бриколаж
            'S032', // Кауфланд
            'S033', // Найден Киров
            'S034', // Олимп
            'S035', // Подстанция
            'S003', // Мол Русе (Трета поликлиника)
            'S077', // Печатница Дунав
            'S076', // ул. Иван Ведър
            'S004', // Автогара Изток
            'S075'  // Гара Разпределителна
        ],
        schedule: {
            weekday: { first: '05:45', last: '20:10', frequency: '15-20 мин' },
            weekend: { first: '06:30', last: '19:30', frequency: '20-30 мин' }
        }
    },
    'T24': {
        number: '24',
        name: 'Линия 24',
        type: 'trolleybus',
        operator: 'gradski',
        route: 'ж.к. Дружба 3 - Център - Централна ЖП гара',
        color: '#dc2626',
        stops: [
            'S022', // ж.к. Дружба 3 (Блок 45)
            'S086', // Хиподрум
            'S087', // бул. България
            'S088', // Левента
            'S090', // Алеко Константинов
            'S093', // бул. Мидия Енос
            'S002', // Централна ЖП гара
            'S080', // ул. Борисова
            'S081', // Лермонтов
            'S082', // Орхидея
            'S083', // Медицински център
            'S084', // бул. Ген. Скобелев
            'S085', // СБА (Скобелев)
            'S001'  // пл. Оборище
        ],
        schedule: {
            weekday: { first: '05:50', last: '21:15', frequency: '15-20 мин' },
            weekend: { first: '06:15', last: '20:30', frequency: '20-25 мин' }
        }
    },
    'T27': {
        number: '27',
        name: 'Линия 27',
        type: 'trolleybus',
        operator: 'gradski',
        route: 'пл. Оборище - Окръжна болница - Русенски университет',
        color: '#dc2626',
        stops: [
            'S001', // пл. Оборище
            'S050', // Спортна зала ОЗК Арена
            'S051', // Пантеона
            'S052', // бул. Съединение
            'S054', // Парк на Възрожденците
            'S055', // Окръжна болница
            'S056', // ул. Плиска
            'S057', // Първа пролет
            'S058', // Русенски университет
            'S059', // кв. Париж
            'S060'  // ж.к. Цветница
        ],
        schedule: {
            weekday: { first: '06:00', last: '20:30', frequency: '18-25 мин' },
            weekend: { first: '07:00', last: '19:30', frequency: '25-35 мин' }
        }
    },
    'T29': {
        number: '29',
        name: 'Линия 29',
        type: 'trolleybus',
        operator: 'gradski',
        route: 'ж.к. Чародейка Юг - Захарен завод',
        color: '#dc2626',
        stops: [
            'S011', // ж.к. Чародейка Юг
            'S014', // бул. Васил Левски
            'S041', // Печатни платки
            'S001', // пл. Оборище
            'S028', // Спортна зала
            'S051', // Пантеона
            'S055', // Окръжна болница
            'S058', // Русенски университет
            'S060', // ж.к. Цветница
            'S065', // бул. Тутракан
            'S066', // ж.к. Тракция (ЛВЗ)
            'S067', // Психодиспансер
            'S068'  // Захарен завод
        ],
        schedule: {
            weekday: { first: '05:55', last: '20:45', frequency: '18-22 мин' },
            weekend: { first: '06:30', last: '19:45', frequency: '25-30 мин' }
        }
    },

    // ─────────────────────────────────────────────────────────────
    // BUS LINES (17)
    // ─────────────────────────────────────────────────────────────
    'B3': {
        number: '3',
        name: 'Линия 3',
        type: 'bus',
        operator: 'ogt',
        route: 'Център - кв. Средна кула',
        color: '#059669',
        stops: ['S001', 'S040', 'S045', 'S103'],
        schedule: {
            weekday: { first: '06:00', last: '20:00', frequency: '30-40 мин' },
            weekend: { first: '07:00', last: '19:00', frequency: '45-60 мин' }
        }
    },
    'B4': {
        number: '4',
        name: 'Линия 4',
        type: 'bus',
        operator: 'ogt',
        route: 'Център - кв. Източна промишлена зона',
        color: '#059669',
        stops: ['S002', 'S001', 'S004', 'S116'],
        schedule: {
            weekday: { first: '06:15', last: '19:30', frequency: '35-45 мин' },
            weekend: { first: '07:30', last: '18:30', frequency: '50-70 мин' }
        }
    },
    'B5': {
        number: '5',
        name: 'Линия 5',
        type: 'bus',
        operator: 'ogt',
        route: 'Център - кв. Образцов чифлик',
        color: '#059669',
        stops: ['S002', 'S080', 'S111'],
        schedule: {
            weekday: { first: '06:30', last: '19:00', frequency: '40-50 мин' },
            weekend: { first: '08:00', last: '18:00', frequency: '60-90 мин' }
        }
    },
    'B6': {
        number: '6',
        name: 'Линия 6',
        type: 'bus',
        operator: 'shans99',
        route: 'Дом на културата - Асфалтова база',
        color: '#059669',
        stops: ['S121', 'S001', 'S030', 'S032', 'S072', 'S122'],
        schedule: {
            weekday: { first: '06:00', last: '19:30', frequency: '25-35 мин' },
            weekend: { first: '07:00', last: '18:30', frequency: '40-50 мин' }
        }
    },
    'B8': {
        number: '8',
        name: 'Линия 8',
        type: 'bus',
        operator: 'ogt',
        route: 'Център - Западна промишлена зона',
        color: '#059669',
        stops: ['S001', 'S040', 'S115'],
        schedule: {
            weekday: { first: '06:20', last: '18:45', frequency: '35-50 мин' },
            weekend: { first: '08:00', last: '17:00', frequency: '60-90 мин' }
        }
    },
    'B10': {
        number: '10',
        name: 'Линия 10',
        type: 'bus',
        operator: 'ogt',
        route: 'Център - кв. Здравец',
        color: '#059669',
        stops: ['S002', 'S001', 'S110'],
        schedule: {
            weekday: { first: '06:30', last: '20:00', frequency: '30-40 мин' },
            weekend: { first: '07:30', last: '19:00', frequency: '45-60 мин' }
        }
    },
    'B11': {
        number: '11',
        name: 'Линия 11',
        type: 'bus',
        operator: 'ogt',
        route: 'кв. Мальовица (Помощно училище) - Дунав мост',
        color: '#059669',
        stops: [
            'S104', // Мальовица (Помощно училище)
            'S105', // ул. Мальовица
            'S106', // ул. Тинтява
            'S107', // бул. Гоце Делчев
            'S108', // Помпена станция
            'S087', // бул. България
            'S089', // Верила
            'S088', // Левента
            'S090', // Училище Алеко Константинов
            'S091', // п.в. Охлюва
            'S092', // ул. Стефан Стамболов
            'S093', // бул. Мидия Енос
            'S094', // ж.к. Мидия Енос
            'S002', // Централна ЖП гара
            'S080', // ул. Борисова
            'S081', // Лермонтов
            'S082', // Орхидея
            'S083', // Медицински център
            'S084', // бул. Ген. Скобелев
            'S085', // Скобелев (СБА)
            'S001', // пл. Оборище
            'S040', // бул. Цар Освободител
            'S050', // Спортна зала ОЗК Арена
            'S051', // Пантеона
            'S052', // бул. Съединение
            'S053', // ул. Св. Наум
            'S054', // Парк на Възрожденците
            'S055', // Окръжна болница
            'S056', // ул. Плиска
            'S057', // Първа пролет
            'S058', // Русенски университет
            'S059', // Париж
            'S060', // ж.к. Цветница
            'S065', // бул. Тутракан
            'S066', // ж.к. Тракция (ЛВЗ)
            'S067', // Психодиспансер
            'S068', // Захарен завод
            'S069', // ПГ по транспорт
            'S070', // Еконт Експрес (Домостроене АД)
            'S071'  // Митница (Дунав мост)
        ],
        schedule: {
            weekday: { first: '05:30', last: '21:15', frequency: '40-55 мин' },
            weekend: { first: '06:30', last: '20:00', frequency: '60-90 мин' }
        }
    },
    'B12': {
        number: '12',
        name: 'Линия 12',
        type: 'bus',
        operator: 'shans99',
        route: 'Централна ЖП гара - Захарен завод',
        color: '#059669',
        stops: [
            'S002', // Централна ЖП гара (ул. Николаевска)
            'S093', // бул. Мидия Енос
            'S092', // ул. Стефан Стамболов
            'S087', // бул. България
            'S088', // Левента
            'S022', // ж.к. Дружба 3
            'S086', // Хиподрум
            'S065', // бул. Тутракан
            'S060', // ж.к. Цветница
            'S058', // Русенски университет
            'S066', // ж.к. Тракция
            'S067', // Психодиспансер
            'S068'  // Захарен завод (Тутракан №25)
        ],
        schedule: {
            weekday: { first: '06:00', last: '20:30', frequency: '12-18 мин' },
            weekend: { first: '06:30', last: '19:30', frequency: '20-25 мин' }
        }
    },
    'B15': {
        number: '15',
        name: 'Линия 15',
        type: 'bus',
        operator: 'shans99',
        route: 'кв. Долапите - Централна ЖП гара',
        color: '#059669',
        stops: ['S100', 'S101', 'S030', 'S001', 'S040', 'S002'],
        schedule: {
            weekday: { first: '06:00', last: '19:30', frequency: '30-40 мин' },
            weekend: { first: '07:00', last: '18:30', frequency: '45-60 мин' }
        }
    },
    'B16': {
        number: '16',
        name: 'Линия 16',
        type: 'bus',
        operator: 'ogt',
        route: 'Гара Разпределителна - кв. Долапите - Петролна база',
        color: '#059669',
        stops: ['S075', 'S004', 'S030', 'S100', 'S102'],
        schedule: {
            weekday: { first: '06:15', last: '18:45', frequency: '40-60 мин' },
            weekend: { first: '08:00', last: '17:00', frequency: '70-90 мин' }
        }
    },
    'B18': {
        number: '18',
        name: 'Линия 18',
        type: 'bus',
        operator: 'ogt',
        route: 'Хиподрум - ж.к. Дружба 3 (Блок 45)',
        color: '#059669',
        stops: [
            'S086', // Хиподрум
            'S087', // бул. България
            'S088', // Левента
            'S090', // Алеко Константинов
            'S093', // бул. Мидия Енос
            'S002', // Централна ЖП гара
            'S080', // ул. Борисова
            'S081', // Лермонтов
            'S082', // Орхидея
            'S084', // бул. Ген. Скобелев
            'S001', // пл. Оборище
            'S030', // бул. Липник
            'S032', // Кауфланд
            'S031', // Мосю Бриколаж
            'S020', // ж.к. Дружба 1
            'S021', // ж.к. Дружба 2
            'S022', // ж.к. Дружба 3
            'S024'  // Блок 45
        ],
        schedule: {
            weekday: { first: '05:50', last: '19:20', frequency: '25-35 мин' },
            weekend: { first: '05:50', last: '18:30', frequency: '35-50 мин' }
        }
    },
    'B19': {
        number: '19',
        name: 'Линия 19',
        type: 'bus',
        operator: 'ogt',
        route: 'Метро - Кооперативен пазар (ЖП прелез)',
        color: '#059669',
        stops: ['S120', 'S030', 'S032', 'S034', 'S003', 'S001', 'S040', 'S044'],
        schedule: {
            weekday: { first: '07:00', last: '19:00', frequency: '35-50 мин' },
            weekend: { first: null, last: null, frequency: 'Не се движи' }
        }
    },
    'B20': {
        number: '20',
        name: 'Линия 20',
        type: 'bus',
        operator: 'ogt',
        route: 'Гимназия по корабостроене - ж.к. Изток (пл. Прага)',
        color: '#059669',
        stops: ['S123', 'S045', 'S040', 'S001', 'S005', 'S112', 'S113'],
        schedule: {
            weekday: { first: '06:05', last: '17:10', frequency: '40-60 мин' },
            weekend: { first: '07:30', last: '17:10', frequency: '70-90 мин' }
        }
    },
    'B23': {
        number: '23',
        name: 'Линия 23',
        type: 'bus',
        operator: 'ogt',
        route: 'ж.к. Дружба 3 - Център - пл. Хан Крум',
        color: '#059669',
        stops: ['S022', 'S021', 'S020', 'S030', 'S001', 'S114'],
        schedule: {
            weekday: { first: '06:00', last: '20:00', frequency: '30-40 мин' },
            weekend: { first: '07:00', last: '19:00', frequency: '45-60 мин' }
        }
    },
    'B28': {
        number: '28',
        name: 'Линия 28',
        type: 'bus',
        operator: 'ogt',
        route: 'ж.к. Дружба 3 - Център - Индустриален парк',
        color: '#059669',
        stops: ['S022', 'S030', 'S001', 'S050', 'S051', 'S055', 'S058', 'S060', 'S072'],
        schedule: {
            weekday: { first: '05:15', last: '20:30', frequency: '25-40 мин' },
            weekend: { first: '06:30', last: '19:00', frequency: '40-60 мин' }
        }
    },
    'B30': {
        number: '30',
        name: 'Линия 30',
        type: 'bus',
        operator: 'ogt',
        route: 'ж.к. Чародейка - Хотел Рига - Център',
        color: '#059669',
        stops: ['S010', 'S042', 'S041', 'S043', 'S040', 'S001'],
        schedule: {
            weekday: { first: '06:00', last: '20:00', frequency: '30-40 мин' },
            weekend: { first: '07:00', last: '19:00', frequency: '45-60 мин' }
        }
    },
    'B33': {
        number: '33',
        name: 'Линия 33',
        type: 'bus',
        operator: 'ogt',
        route: 'Гара Разпределителна - Образцов чифлик',
        color: '#059669',
        stops: ['S075', 'S004', 'S030', 'S001', 'S002', 'S111'],
        schedule: {
            weekday: { first: '05:55', last: '19:20', frequency: '60-120 мин' },
            weekend: { first: '07:00', last: '18:00', frequency: '90-150 мин' }
        }
    }
};

// ═══════════════════════════════════════════════════════════════
// ROUTE GEOMETRIES (GeoJSON LineStrings)
// ═══════════════════════════════════════════════════════════════
const ROUTE_GEOMETRIES = {
    'T2': { type: 'LineString', coordinates: [[25.971998,43.82669],[25.971927,43.826697],[25.972019,43.827098],[25.97204,43.827312],[25.972047,43.827458],[25.972006,43.827601],[25.971858,43.827894],[25.971278,43.828434],[25.970908,43.82875],[25.969959,43.829606],[25.969783,43.829743],[25.969504,43.830006],[25.969199,43.830309],[25.968383,43.831056],[25.967865,43.831468],[25.967447,43.831776],[25.967264,43.831895],[25.967197,43.832174],[25.968224,43.832813],[25.968744,43.833073],[25.969225,43.832698],[25.969775,43.832242],[25.970036,43.832102],[25.970458,43.832427],[25.970154,43.832638],[25.96962,43.833007],[25.968733,43.833622],[25.967809,43.834252],[25.967482,43.834451],[25.966869,43.834862],[25.965831,43.83557],[25.964566,43.836408],[25.963814,43.836916],[25.962687,43.837676],[25.960754,43.839125],[25.960303,43.839483],[25.960021,43.839632],[25.959754,43.83968],[25.959439,43.839696],[25.958832,43.839691],[25.957415,43.839427],[25.956769,43.839341],[25.955219,43.83914],[25.955025,43.839323],[25.954978,43.839576],[25.954863,43.840245],[25.954774,43.840825],[25.954569,43.842088],[25.954386,43.843169],[25.954093,43.844735],[25.95405,43.844984],[25.953907,43.846009],[25.953835,43.846453],[25.952197,43.846409],[25.951948,43.847112],[25.95246,43.847319],[25.952848,43.847573],[25.953313,43.847916],[25.953313,43.847916],[25.952848,43.847573],[25.951948,43.847112],[25.950658,43.847108],[25.949762,43.84714],[25.948537,43.846892],[25.947337,43.847137],[25.946238,43.847435],[25.945751,43.847568],[25.945558,43.847384],[25.945045,43.847108],[25.944608,43.846579],[25.944102,43.845821],[25.943822,43.845083],[25.943685,43.844702],[25.943759,43.844341],[25.944046,43.843967],[25.944506,43.843699],[25.944917,43.843536],[25.945168,43.843276],[25.945629,43.842849],[25.946707,43.841837],[25.947299,43.841258],[25.948091,43.840575],[25.948344,43.840257],[25.948442,43.839873],[25.948807,43.838727],[25.949097,43.837895],[25.949705,43.838155],[25.950531,43.838492],[25.950977,43.838694],[25.952174,43.838809],[25.95494,43.839062],[25.956246,43.839185],[25.958652,43.839556],[25.95912,43.839593],[25.95953,43.839562],[25.959894,43.839478],[25.960225,43.839321],[25.960691,43.838968],[25.962453,43.83766],[25.964415,43.836344],[25.965379,43.835672],[25.96675,43.834768],[25.967978,43.833933],[25.968212,43.833704],[25.96811,43.833549],[25.968224,43.832813]] },
    'T9': { type: 'LineString', coordinates: [[25.96601,43.828003],[25.966317,43.828291],[25.967122,43.828591],[25.967729,43.828826],[25.968493,43.829092],[25.969413,43.829469],[25.969876,43.829682],[25.970343,43.829952],[25.970995,43.83039],[25.97139,43.830721],[25.971901,43.831196],[25.972117,43.831383],[25.971398,43.831835],[25.970837,43.832187],[25.970154,43.832638],[25.96962,43.833007],[25.968733,43.833622],[25.967809,43.834252],[25.96718,43.834662],[25.965831,43.83557],[25.964566,43.836408],[25.963814,43.836916],[25.962687,43.837676],[25.960754,43.839125],[25.960178,43.839555],[25.959754,43.83968],[25.959033,43.839706],[25.957415,43.839427],[25.95639,43.839294],[25.955062,43.839119],[25.954978,43.839576],[25.954809,43.840616],[25.954569,43.842088],[25.954386,43.843169],[25.954066,43.844884],[25.953907,43.846009],[25.953697,43.846447],[25.951948,43.847112],[25.952607,43.847413],[25.953243,43.847853],[25.953313,43.847916],[25.952783,43.847527],[25.951948,43.847112],[25.950658,43.847108],[25.949748,43.847137],[25.948338,43.846845],[25.946503,43.847363],[25.945751,43.847568],[25.945149,43.847186],[25.944608,43.846579],[25.944102,43.845821],[25.943822,43.845083],[25.943759,43.844341],[25.944188,43.843874],[25.944829,43.843585],[25.945629,43.842849],[25.946812,43.841732],[25.947956,43.840711],[25.948344,43.840257],[25.948732,43.838977],[25.949097,43.837895],[25.949366,43.836917],[25.949801,43.835741],[25.950057,43.834745],[25.950219,43.833078],[25.950401,43.831751],[25.950358,43.831244],[25.950148,43.830952],[25.949633,43.830345],[25.949401,43.829945],[25.949336,43.829586],[25.949316,43.828355],[25.949261,43.828045],[25.949635,43.827496],[25.950389,43.826861],[25.951516,43.826808],[25.953457,43.82757],[25.954916,43.827968],[25.955002,43.827997]] },
    'T13': { type: 'LineString', coordinates: [[25.986996,43.855017],[25.985617,43.854833],[25.982708,43.854441],[25.981627,43.854065],[25.979945,43.853488],[25.979239,43.853386],[25.978915,43.853464],[25.978646,43.853337],[25.978642,43.853145],[25.978826,43.852204],[25.979162,43.850579],[25.976673,43.850251],[25.975412,43.849845],[25.973137,43.849012],[25.96746,43.847443],[25.96627,43.847108],[25.964743,43.846662],[25.963353,43.846489],[25.961024,43.846133],[25.960568,43.846173],[25.960226,43.846305],[25.959899,43.846235],[25.959578,43.845934],[25.958206,43.845616],[25.957219,43.845294],[25.956411,43.845008],[25.955731,43.844891],[25.954803,43.844909],[25.954066,43.844884],[25.953931,43.845835],[25.953845,43.846372],[25.952197,43.846409],[25.952607,43.847413],[25.953313,43.847916],[25.952783,43.847527],[25.951705,43.847097],[25.950658,43.847108],[25.949315,43.847047],[25.948338,43.846845],[25.946503,43.847363],[25.945751,43.847568],[25.945045,43.847108],[25.944241,43.846076],[25.94398,43.845555],[25.943685,43.844702],[25.943838,43.844195],[25.944506,43.843699],[25.945168,43.843276],[25.946161,43.842349],[25.947192,43.841371],[25.948091,43.840575],[25.948442,43.839873],[25.948807,43.838727],[25.949222,43.837402],[25.949674,43.836127],[25.949864,43.835509],[25.95015,43.833745],[25.950274,43.83276],[25.950417,43.831659],[25.950358,43.831244],[25.949906,43.830636],[25.949456,43.830076],[25.949352,43.829762],[25.949344,43.828668],[25.949479,43.828255],[25.950249,43.828566],[25.95046,43.828875],[25.950536,43.829386],[25.95096,43.829613],[25.951728,43.830024],[25.953139,43.830701],[25.954625,43.831301],[25.95696,43.832189],[25.958954,43.830887],[25.960623,43.829828],[25.961519,43.829248],[25.963524,43.827652],[25.963386,43.826812],[25.962757,43.826513],[25.962073,43.826309],[25.961403,43.82629],[25.960459,43.826216],[25.960423,43.824444],[25.962028,43.82441]] },
    'T21': { type: 'LineString', coordinates: [[25.966,43.828],[25.967122,43.828591],[25.968493,43.829092],[25.969876,43.829682],[25.970995,43.83039],[25.972117,43.831383],[25.970837,43.832187],[25.96962,43.833007],[25.967809,43.834252],[25.965831,43.83557],[25.963814,43.836916],[25.960754,43.839125],[25.959754,43.83968],[25.957415,43.839427],[25.955062,43.839119],[25.954978,43.839576],[25.954569,43.842088],[25.954066,43.844884],[25.953907,43.846009],[25.952197,43.846409],[25.952607,43.847413],[25.953313,43.847916],[25.951948,43.847112],[25.949748,43.847137],[25.946503,43.847363],[25.945767,43.847682],[25.9459,43.848072],[25.946283,43.848481],[25.94681,43.848876],[25.947567,43.849394],[25.948006,43.849719],[25.948499,43.850242],[25.949176,43.850903],[25.95006,43.85186],[25.950307,43.852064],[25.950916,43.852401],[25.9518,43.852516],[25.952679,43.852578],[25.953594,43.852531],[25.955922,43.852523],[25.956718,43.851948],[25.957353,43.851236],[25.958137,43.850272],[25.958849,43.850277],[25.959234,43.850511],[25.95998,43.851374],[25.961181,43.853051],[25.961709,43.853435],[25.962099,43.853704],[25.962645,43.853798],[25.963604,43.853703],[25.964025,43.853532],[25.964693,43.852763],[25.964928,43.852161],[25.965822,43.851067],[25.966459,43.851075],[25.968271,43.851972],[25.967682,43.850876],[25.966884,43.850004],[25.965825,43.85078],[25.965192,43.851441],[25.964956,43.85206],[25.964693,43.852763],[25.964142,43.853661],[25.964559,43.854103],[25.965134,43.854459],[25.966648,43.855196],[25.968596,43.856135],[25.970663,43.857122],[25.972733,43.858139],[25.973814,43.858652],[25.975066,43.857311],[25.97609,43.856391],[25.976591,43.855912],[25.975985,43.855615]] },
    'T24': { type: 'LineString', coordinates: [[25.972,43.8267],[25.9718,43.8279],[25.9712,43.8284],[25.9699,43.8296],[25.9692,43.8303],[25.9683,43.8311],[25.9672,43.8319],[25.9665,43.8324],[25.9655,43.833],[25.9631,43.8338],[25.96,43.834],[25.9578,43.834],[25.956,43.8337],[25.9555,43.834],[25.9553,43.8356],[25.9548,43.838],[25.954,43.842],[25.9533,43.8453],[25.9533,43.8479],[25.9522,43.8475],[25.95,43.8471],[25.9486,43.8469],[25.9463,43.8474],[25.9458,43.8473]] },
    'T27': { type: 'LineString', coordinates: [[25.953313,43.847916],[25.952783,43.847527],[25.951948,43.847112],[25.950658,43.847108],[25.949748,43.847137],[25.946503,43.847363],[25.945767,43.847682],[25.9459,43.848072],[25.946283,43.848481],[25.94681,43.848876],[25.947567,43.849394],[25.948006,43.849719],[25.948499,43.850242],[25.949176,43.850903],[25.95006,43.85186],[25.950307,43.852064],[25.950916,43.852401],[25.9518,43.852516],[25.952679,43.852578],[25.953594,43.852531],[25.955922,43.852523],[25.956718,43.851948],[25.957353,43.851236],[25.958137,43.850272],[25.958849,43.850277],[25.959234,43.850511],[25.95998,43.851374],[25.961181,43.853051],[25.961709,43.853435],[25.962645,43.853798],[25.964188,43.854127],[25.965711,43.85474],[25.967646,43.855677],[25.969567,43.856599],[25.971321,43.857451],[25.973814,43.858652],[25.975066,43.857311],[25.97609,43.856391],[25.975985,43.855615]] },
    'T29': { type: 'LineString', coordinates: [[25.966,43.828],[25.967729,43.828826],[25.969413,43.829469],[25.970995,43.83039],[25.972117,43.831383],[25.970837,43.832187],[25.96962,43.833007],[25.967809,43.834252],[25.965831,43.83557],[25.963814,43.836916],[25.960754,43.839125],[25.959754,43.83968],[25.955062,43.839119],[25.954569,43.842088],[25.954066,43.844884],[25.953907,43.846009],[25.952197,43.846409],[25.952607,43.847413],[25.953313,43.847916],[25.949748,43.847137],[25.945767,43.847682],[25.946283,43.848481],[25.947567,43.849394],[25.949176,43.850903],[25.950916,43.852401],[25.953594,43.852531],[25.956718,43.851948],[25.958137,43.850272],[25.959234,43.850511],[25.961181,43.853051],[25.962645,43.853798],[25.965711,43.85474],[25.969567,43.856599],[25.973814,43.858652],[25.976771,43.860124],[25.979697,43.861537],[25.981211,43.862756],[25.982513,43.863839],[25.984928,43.865127],[25.987595,43.866507],[25.990054,43.867474],[25.99201,43.868293],[25.995395,43.869687],[25.996658,43.870262],[25.997482,43.87037],[25.998242,43.870965],[25.999505,43.871553],[26.000332,43.871731],[26.007786,43.873062],[26.010483,43.873645],[26.013298,43.874191],[26.014148,43.874529],[26.015842,43.875462],[26.016488,43.875497],[26.016927,43.875831],[26.017374,43.876474],[26.017871,43.876985],[26.018824,43.877628],[26.019789,43.878281]] },
    'B3': { type: 'LineString', coordinates: [[25.9533,43.8479],[25.951,43.8465],[25.948,43.8445],[25.945,43.841],[25.942,43.836],[25.938,43.83],[25.934,43.823],[25.93,43.816],[25.927,43.81],[25.925,43.805]] },
    'B4': { type: 'LineString', coordinates: [[25.9556,43.8334],[25.958,43.836],[25.96,43.84],[25.9533,43.8479],[25.958,43.849],[25.965,43.85],[25.975,43.851],[25.982,43.852],[25.99,43.855]] },
    'B5': { type: 'LineString', coordinates: [[25.9556,43.8334],[25.958,43.833],[25.962,43.831],[25.965,43.828]] },
    'B6': { type: 'LineString', coordinates: [[25.951,43.8495],[25.9533,43.8479],[25.958,43.847],[25.965,43.848],[25.972,43.849],[25.98,43.851],[25.985,43.853]] },
    'B8': { type: 'LineString', coordinates: [[25.9533,43.8479],[25.95,43.847],[25.945,43.845],[25.94,43.842],[25.935,43.84]] },
    'B10': { type: 'LineString', coordinates: [[25.9556,43.8334],[25.955,43.836],[25.954,43.84],[25.9533,43.8479],[25.956,43.842],[25.958,43.83],[25.958,43.818]] },
    'B11': { type: 'LineString', coordinates: [[25.939845,43.809839],[25.938218,43.810074],[25.937257,43.809923],[25.937127,43.808882],[25.936474,43.807868],[25.936249,43.806946],[25.936427,43.806685],[25.939445,43.806622],[25.94171,43.806582],[25.942031,43.806698],[25.942749,43.807],[25.94244,43.807283],[25.942418,43.807578],[25.942965,43.808542],[25.943557,43.809595],[25.943647,43.810152],[25.943493,43.811034],[25.943106,43.811685],[25.942368,43.812436],[25.941451,43.81347],[25.940652,43.81461],[25.939906,43.816485],[25.939506,43.817439],[25.93915,43.818065],[25.938365,43.818811],[25.93777,43.819352],[25.937283,43.819984],[25.937291,43.82031],[25.937944,43.821189],[25.938812,43.822221],[25.939544,43.822647],[25.940874,43.823429],[25.94159,43.82394],[25.942519,43.824731],[25.943167,43.825019],[25.944751,43.826275],[25.945637,43.826833],[25.947034,43.827604],[25.94802,43.828106],[25.949896,43.829117],[25.949444,43.82871],[25.949476,43.829604],[25.949787,43.830331],[25.950762,43.831499],[25.953289,43.832716],[25.955232,43.833748],[25.955916,43.834307],[25.955548,43.836117],[25.955231,43.838058],[25.955062,43.839119],[25.954863,43.840245],[25.954569,43.842088],[25.954066,43.844884],[25.953845,43.846372],[25.951948,43.847112],[25.952607,43.847413],[25.953313,43.847916],[25.949748,43.847137],[25.945767,43.847682],[25.946283,43.848481],[25.947567,43.849394],[25.948499,43.850242],[25.949841,43.851628],[25.950916,43.852401],[25.953594,43.852531],[25.956718,43.851948],[25.958137,43.850272],[25.959234,43.850511],[25.961181,43.853051],[25.962645,43.853798],[25.965711,43.85474],[25.969567,43.856599],[25.973814,43.858652],[25.976771,43.860124],[25.979697,43.861537],[25.982172,43.863629],[25.985882,43.865653],[25.99201,43.868293],[25.99653,43.870203],[25.997482,43.87037],[25.999505,43.871553],[26.007786,43.873062],[26.012583,43.874034],[26.015717,43.875394],[26.016751,43.875619],[26.017374,43.876474],[26.018193,43.87721],[26.019266,43.877923],[26.022508,43.880145],[26.022787,43.880258],[26.02296,43.880355],[26.022906,43.880553],[26.022562,43.880539],[26.019694,43.878386],[26.018495,43.877605],[26.017776,43.877128],[26.017047,43.876821],[26.016865,43.877058],[26.016499,43.877769],[26.015927,43.87799],[26.015651,43.878458],[26.015198,43.878971],[26.015093,43.879391],[26.014372,43.880202],[26.007834,43.886762],[26.006051,43.888558]] },
    'B12': { type: 'LineString', coordinates: [[25.9556,43.8334],[25.958,43.835],[25.962,43.838],[25.968,43.842],[25.972,43.846],[25.976,43.85],[25.98,43.856],[25.983,43.862],[25.986,43.868]] },
    'B15': { type: 'LineString', coordinates: [[25.931028,43.79704],[25.930631,43.79649],[25.929876,43.795933],[25.928909,43.795442],[25.927489,43.794643],[25.926541,43.794177],[25.92601,43.794065],[25.924714,43.793957],[25.924021,43.794061],[25.92345,43.794225],[25.922176,43.794747],[25.921406,43.795138],[25.920468,43.795488],[25.919637,43.795619],[25.918506,43.795863],[25.918016,43.796064],[25.917704,43.796384],[25.917932,43.7968],[25.918499,43.797791],[25.919177,43.799004],[25.9195,43.7997],[25.920751,43.802659],[25.921158,43.803631],[25.921728,43.804954],[25.922235,43.806],[25.922701,43.806705],[25.923494,43.807627],[25.924392,43.808455],[25.925914,43.809836],[25.926889,43.810743],[25.927325,43.811254],[25.928015,43.812326],[25.928597,43.813607],[25.929104,43.814764],[25.929618,43.815887],[25.929945,43.816519],[25.930486,43.817248],[25.931041,43.817801],[25.931906,43.818413],[25.933361,43.819177],[25.935097,43.82001],[25.937813,43.821291],[25.939767,43.822333],[25.94055,43.822933],[25.942316,43.824346],[25.943726,43.825444],[25.945276,43.826625],[25.947034,43.827604],[25.94802,43.828106],[25.949896,43.829117],[25.949444,43.82871],[25.949476,43.829604],[25.950426,43.831135],[25.951154,43.831863],[25.953289,43.832716],[25.955232,43.833748],[25.955909,43.83437],[25.955548,43.836117],[25.955231,43.838058],[25.955062,43.839119],[25.954863,43.840245],[25.954569,43.842088],[25.954269,43.843801],[25.954066,43.844884],[25.953907,43.846009],[25.953697,43.846447],[25.951948,43.847112],[25.952607,43.847413],[25.953313,43.847916],[25.949748,43.847137],[25.946503,43.847363],[25.945149,43.847186],[25.944608,43.846579],[25.943822,43.845083],[25.943838,43.844195],[25.945168,43.843276],[25.946812,43.841732],[25.948344,43.840257],[25.948807,43.838727],[25.949222,43.837402],[25.949864,43.835509],[25.95015,43.833745],[25.950311,43.832461],[25.950705,43.831724],[25.951154,43.831863],[25.953289,43.832716],[25.955232,43.833748],[25.955526,43.833476]] },
    'B16': { type: 'LineString', coordinates: [[25.987,43.855],[25.98,43.852],[25.97,43.849],[25.96,43.845],[25.95,43.84],[25.94,43.83],[25.935,43.815],[25.931,43.797],[25.925,43.792],[25.92,43.79]] },
    'B18': { type: 'LineString', coordinates: [[25.968,43.82],[25.965,43.825],[25.96,43.83],[25.9556,43.8334],[25.954,43.84],[25.9533,43.8479],[25.958,43.845],[25.965,43.842],[25.96,43.835],[25.962,43.83],[25.968,43.827],[25.972,43.8267]] },
    'B19': { type: 'LineString', coordinates: [[25.96,43.842],[25.962,43.845],[25.968,43.848],[25.975,43.85],[25.985,43.853],[25.99,43.854],[25.97,43.85],[25.96,43.848],[25.9533,43.8479],[25.955,43.844],[25.958,43.84]] },
    'B20': { type: 'LineString', coordinates: [[25.96,43.856],[25.956,43.852],[25.9533,43.8479],[25.958,43.845],[25.965,43.842],[25.968,43.84]] },
    'B23': { type: 'LineString', coordinates: [[25.972,43.8267],[25.968,43.829],[25.962,43.83],[25.955,43.828],[25.956,43.835],[25.9533,43.8479],[25.952,43.851]] },
    'B28': { type: 'LineString', coordinates: [[25.972,43.8267],[25.968,43.832],[25.962,43.838],[25.9533,43.8479],[25.956,43.8445],[25.962,43.847],[25.968,43.851],[25.976,43.8556],[25.98,43.86],[25.985,43.865]] },
    'B30': { type: 'LineString', coordinates: [[25.968,43.833],[25.965,43.836],[25.96,43.84],[25.956,43.844],[25.9533,43.8479]] },
    'B33': { type: 'LineString', coordinates: [[25.987,43.855],[25.982,43.852],[25.975,43.85],[25.965,43.847],[25.9533,43.8479],[25.9556,43.8334],[25.96,43.83],[25.965,43.828]] }
};

// ═══════════════════════════════════════════════════════════════
// OPERATORS
// ═══════════════════════════════════════════════════════════════
const OPERATORS = {
    'gradski': {
        name: 'Градски транспорт АД',
        type: 'trolleybus',
        website: 'https://www.transport-ruse.com/'
    },
    'shans99': {
        name: 'ШАНС-99 ООД',
        type: 'bus',
        website: ''
    },
    'geocomers': {
        name: 'Геокомерс ООД',
        type: 'bus',
        website: ''
    },
    'ogt': {
        name: 'Общински градски транспорт ЕАД',
        type: 'bus',
        website: ''
    }
};

// ═══════════════════════════════════════════════════════════════
// CONFIG
// ═══════════════════════════════════════════════════════════════
const CONFIG = {
    center: [43.8356, 25.9657],
    defaultZoom: 13,
    fares: {
        singleRide: 1.60,
        currency: 'лв.',
        paymentMethods: ['Кеш при шофьора', 'Електронна карта', 'Абонаментна карта'],
        notes: 'Всички линии са с безкондукторно обслужване.'
    }
};

// ═══════════════════════════════════════════════════════════════
// HELPER FUNCTIONS
// ═══════════════════════════════════════════════════════════════

/**
 * Get stop by ID
 */
function getStop(stopId) {
    return STOPS[stopId] || null;
}

/**
 * Get stop name by ID
 */
function getStopName(stopId) {
    const stop = STOPS[stopId];
    return stop ? stop.name : 'Неизвестна спирка';
}

/**
 * Get line by ID
 */
function getLine(lineId) {
    return LINES[lineId] || null;
}

/**
 * Get all stops for a line (with full data)
 */
function getLineStops(lineId) {
    const line = LINES[lineId];
    if (!line) return [];

    return line.stops.map((stopId, index) => ({
        id: stopId,
        index: index,
        ...STOPS[stopId]
    }));
}

/**
 * Get stop position in line (0-based index)
 */
function getStopPositionInLine(lineId, stopId) {
    const line = LINES[lineId];
    if (!line) return -1;
    return line.stops.indexOf(stopId);
}

/**
 * Build reverse index: stopId -> [lineIds]
 */
function buildStopToLinesIndex() {
    const index = {};
    for (const [lineId, line] of Object.entries(LINES)) {
        for (const stopId of line.stops) {
            if (!index[stopId]) {
                index[stopId] = [];
            }
            if (!index[stopId].includes(lineId)) {
                index[stopId].push(lineId);
            }
        }
    }
    return index;
}

// Pre-compute the index
const STOP_LINES_INDEX = buildStopToLinesIndex();

/**
 * Get all lines that pass through a stop
 */
function getLinesForStop(stopId) {
    const lineIds = STOP_LINES_INDEX[stopId] || [];
    return lineIds.map(id => ({ id, ...LINES[id] }));
}

/**
 * Get line IDs for a stop (fast lookup)
 */
function getLineIdsForStop(stopId) {
    return STOP_LINES_INDEX[stopId] || [];
}

/**
 * Search stops by name or alias
 */
function searchStops(query) {
    const q = query.toLowerCase();
    const results = [];

    for (const [id, stop] of Object.entries(STOPS)) {
        const nameMatch = stop.name.toLowerCase().includes(q);
        const aliasMatch = stop.aliases.some(a => a.toLowerCase().includes(q));

        if (nameMatch || aliasMatch) {
            results.push({ id, ...stop, lines: getLineIdsForStop(id) });
        }
    }

    return results;
}

/**
 * Find stop ID by name (exact or alias match)
 */
function findStopIdByName(name) {
    const n = name.toLowerCase();
    for (const [id, stop] of Object.entries(STOPS)) {
        if (stop.name.toLowerCase() === n) return id;
        if (stop.aliases.some(a => a.toLowerCase() === n)) return id;
    }
    return null;
}

/**
 * Get all stops as array (for map rendering)
 */
function getAllStops() {
    return Object.entries(STOPS).map(([id, stop]) => ({
        id,
        ...stop,
        lines: getLineIdsForStop(id)
    }));
}

/**
 * Get all lines as array
 */
function getAllLines() {
    return Object.entries(LINES).map(([id, line]) => ({
        id,
        ...line
    }));
}

/**
 * Get trolleybus lines
 */
function getTrolleybusLines() {
    return getAllLines().filter(l => l.type === 'trolleybus');
}

/**
 * Get bus lines
 */
function getBusLines() {
    return getAllLines().filter(l => l.type === 'bus');
}

// ═══════════════════════════════════════════════════════════════
// VALIDATION
// ═══════════════════════════════════════════════════════════════

function validateData() {
    const errors = [];
    const warnings = [];

    // Check all line stop references
    for (const [lineId, line] of Object.entries(LINES)) {
        for (let i = 0; i < line.stops.length; i++) {
            const stopId = line.stops[i];
            if (!STOPS[stopId]) {
                errors.push(`Line ${lineId}: references non-existent stop "${stopId}" at position ${i}`);
            }
        }

        // Check for duplicate consecutive stops
        for (let i = 1; i < line.stops.length; i++) {
            if (line.stops[i] === line.stops[i-1]) {
                warnings.push(`Line ${lineId}: duplicate consecutive stop "${line.stops[i]}" at position ${i}`);
            }
        }
    }

    // Check for orphan stops
    for (const stopId of Object.keys(STOPS)) {
        if (!STOP_LINES_INDEX[stopId] || STOP_LINES_INDEX[stopId].length === 0) {
            warnings.push(`Stop ${stopId} (${STOPS[stopId].name}) is not used by any line`);
        }
    }

    return { errors, warnings, valid: errors.length === 0 };
}

// ═══════════════════════════════════════════════════════════════
// ESTIMATED ARRIVAL (improved)
// ═══════════════════════════════════════════════════════════════

function calculateEstimatedArrival(lineId, stopId) {
    const line = LINES[lineId];
    if (!line) return { available: false, message: 'Линията не съществува' };

    const now = new Date();
    const currentHour = now.getHours();
    const currentMinute = now.getMinutes();
    const isWeekend = now.getDay() === 0 || now.getDay() === 6;

    const schedule = isWeekend ? line.schedule.weekend : line.schedule.weekday;

    if (!schedule.first) {
        return { available: false, message: 'Не се движи днес' };
    }

    const [firstHour, firstMin] = schedule.first.split(':').map(Number);
    const [lastHour, lastMin] = schedule.last.split(':').map(Number);

    const currentTimeMinutes = currentHour * 60 + currentMinute;
    const firstTimeMinutes = firstHour * 60 + firstMin;
    const lastTimeMinutes = lastHour * 60 + lastMin;

    if (currentTimeMinutes < firstTimeMinutes) {
        return {
            available: true,
            nextArrival: schedule.first,
            message: `Първи курс в ${schedule.first}`
        };
    }

    if (currentTimeMinutes > lastTimeMinutes) {
        return {
            available: false,
            message: `Последен курс беше в ${schedule.last}`
        };
    }

    // Get frequency
    const frequencyMatch = schedule.frequency.match(/(\d+)/);
    const avgFrequency = frequencyMatch ? parseInt(frequencyMatch[1]) : 15;

    // Use stop position to adjust arrival time
    const stopIndex = getStopPositionInLine(lineId, stopId);
    const stopCount = line.stops.length;
    const positionRatio = stopIndex >= 0 ? stopIndex / stopCount : 0.5;

    // Estimate minutes until next arrival (using position)
    const baseMinutes = Math.floor(Math.random() * avgFrequency);
    const positionAdjustment = Math.floor(positionRatio * avgFrequency * 0.5);
    const minutesUntilNext = Math.max(0, baseMinutes + positionAdjustment);

    const nextArrivalMinutes = currentTimeMinutes + minutesUntilNext;
    const nextHour = Math.floor(nextArrivalMinutes / 60);
    const nextMin = nextArrivalMinutes % 60;

    return {
        available: true,
        nextArrival: `${String(nextHour).padStart(2, '0')}:${String(nextMin).padStart(2, '0')}`,
        minutesUntil: minutesUntilNext,
        message: minutesUntilNext <= 1 ? 'Пристига!' : `След ~${minutesUntilNext} мин`,
        frequency: schedule.frequency
    };
}

// ═══════════════════════════════════════════════════════════════
// GEOJSON GENERATION
// ═══════════════════════════════════════════════════════════════

/**
 * Create GeoJSON for stops (for Leaflet)
 */
function createStopsGeoJSON() {
    return {
        type: 'FeatureCollection',
        features: getAllStops().map(stop => ({
            type: 'Feature',
            properties: {
                id: stop.id,
                name: stop.name,
                type: stop.type,
                lines: stop.lines
            },
            geometry: {
                type: 'Point',
                coordinates: [stop.lng, stop.lat]
            }
        }))
    };
}

/**
 * Create GeoJSON for routes (for Leaflet)
 */
function createRoutesGeoJSON() {
    return {
        type: 'FeatureCollection',
        features: getAllLines().map(line => ({
            type: 'Feature',
            properties: {
                id: line.id,
                number: line.number,
                name: line.name,
                type: line.type,
                route: line.route,
                color: line.color
            },
            geometry: ROUTE_GEOMETRIES[line.id] || { type: 'LineString', coordinates: [] }
        }))
    };
}

// ═══════════════════════════════════════════════════════════════
// EXPORT
// ═══════════════════════════════════════════════════════════════

if (typeof module !== 'undefined' && module.exports) {
    module.exports = {
        STOPS,
        LINES,
        OPERATORS,
        CONFIG,
        ROUTE_GEOMETRIES,
        getStop,
        getStopName,
        getLine,
        getLineStops,
        getStopPositionInLine,
        getLinesForStop,
        getLineIdsForStop,
        searchStops,
        findStopIdByName,
        getAllStops,
        getAllLines,
        getTrolleybusLines,
        getBusLines,
        validateData,
        calculateEstimatedArrival,
        createStopsGeoJSON,
        createRoutesGeoJSON
    };
}

// For browser global access
if (typeof window !== 'undefined') {
    window.TRANSIT_DATA = {
        STOPS,
        LINES,
        OPERATORS,
        CONFIG,
        ROUTE_GEOMETRIES,
        // Expose helper functions
        getStop,
        getStopName,
        getLine,
        getLineStops,
        getStopPositionInLine,
        getLinesForStop,
        getLineIdsForStop,
        searchStops,
        findStopIdByName,
        getAllStops,
        getAllLines,
        getTrolleybusLines,
        getBusLines,
        validateData,
        calculateEstimatedArrival,
        createStopsGeoJSON,
        createRoutesGeoJSON,
        // Compatibility aliases
        center: CONFIG.center,
        defaultZoom: CONFIG.defaultZoom,
        trolleybusLines: getTrolleybusLines(),
        busLines: getBusLines()
    };
}
